---
title: "alluvial diagrams in ggplot2"
author: "Jason Cory Brunson"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{alluvial diagrams in ggplot2}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

The **ggalluvial** package strives to adapt the style and flexibility of the [**alluvial**](https://github.com/mbojan/alluvial) package to the principles and frameworks of the [**tidyverse**](https://github.com/tidyverse).
This vignette

- defines the essential components of alluvial diagrams as used in the naming schemes and documentation (*axis*, *alluvium*, *stratum*, *lode*, *flow*),
- describes the alluvial data structures recognized by **ggalluvial**,
- illustrates the new stats and geoms, and
- showcases some popular variants on the theme and how to produce them.

```{r setup, echo=FALSE, message=FALSE, results='hide'}
library(ggalluvial)
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.align = "center")
```

## Alluvial diagrams

Here's a quintessential (categorical) alluvial diagram:

```{r example alluvial diagram using Titanic dataset, echo=FALSE}
ggplot(data = to_lodes(as.data.frame(Titanic),
                       key = "Demographic",
                       axes = 1:3),
       aes(x = Demographic, stratum = value, alluvium = id,
           weight = Freq, label = value)) +
  geom_alluvium(aes(fill = Survived)) +
  geom_stratum() + geom_text(stat = "stratum") +
  ggtitle("passengers on the maiden voyage of the Titanic",
          "stratified by demographics and survival")
```

The next section details how the elements of this image encode information about the underlying dataset.
For now, we use the image as a point of reference to define the following elements of a typical alluvial diagram:

- An *axis* is a dimension (variable) along which the data are vertically grouped at a fixed horizontal position. The diagram above uses three categorical axes: `Class`, `Sex`, and `Age`.
- The groups at each axis are depicted as opaque blocks called *strata*. For example, the `Class` axis contains four strata: `1st`, `2nd`, `3rd`, and `Crew`.
- Horizontal (x-) splines called *alluvia* span the width of the diagram. In this diagram, each alluvium corresponds to a fixed value of each axis variable, indicated by its vertical position at the axis, as well as of the `Survived` variable, indicated by its fill color.
- The segments of the alluvia between pairs of adjacent axes are *flows*.
- The alluvia intersect the strata at *lodes*, The lodes are not visualized in the above diagram, but they can be inferred as filled rectangles extending the flows through the strata at each end of the diagram or connecting the flows on either side of the center stratum.

As the examples in the next section will demonstrate, which of these elements are incorporated into an alluvial diagram depends on both how the underlying data is structured and what the creator wants the diagram to communicate.

## Alluvial data

### One row per alluvium

**ggalluvial** recognizes two formats of "alluvial data". The first follows the visual arrangement of an alluvial diagram: Each row corresponds to a subset or amount of observations that take a specific value at each variable, and each variable has its own column. An additional column contains the weight of each row. This is the format into which the base function `as.data.frame()` transforms a frequency table, for instance the 3-dimensional `UCBAdmissions` dataset:

```{r Berkeley admissions dataset}
head(as.data.frame(UCBAdmissions), n = 12)
is_alluvial(as.data.frame(UCBAdmissions), logical = FALSE)
```

This form was inherited from the first version of **ggalluvial**, which modeled it after usage in **alluvial**. It required a stark departure from the usual position aesthetics: The user declares any number of axis variables, which `stat_alluvium()` and `stat_stratum()` recognize and process in a consistent way:

```{r alluvial diagram of UC Berkeley admissions dataset}
ggplot(as.data.frame(UCBAdmissions),
       aes(weight = Freq, axis1 = Gender, axis2 = Dept)) +
  geom_alluvium(aes(fill = Admit), width = 1/12) +
  geom_stratum(width = 1/12, fill = "black", color = "grey") +
  geom_label(stat = "stratum", label.strata = TRUE) +
  scale_x_continuous(breaks = 1:2, labels = c("Gender", "Dept")) +
  ggtitle("UC Berkeley admissions and rejections, by sex and department")
```

An important feature of these diagrams is the meaningfulness of the vertical axis: No gaps are inserted between the strata, so the total height of the diagram reflects the cumulative weight of the observations. The diagrams produced by **ggalluvial** conform (somewhat; see below) to the "grammar of graphics" principles of **ggplot2**, and this prevents users from producing "free-floating" diagrams like the Sankey diagrams showcased [here](https://developers.google.com/chart/interactive/docs/gallery/sankey).
**ggalluvial** parameters and existing **ggplot2** functionality can also produce [parallel sets](https://eagereyes.org/parallel-sets) plots, illustrated here using the `Titanic` dataset:[^ggparallel]

[^ggparallel]: A greater variety of parallel sets plots are implemented in [the **ggparallel** package](https://github.com/heike/ggparallel).

```{r parallel sets plot of Titanic dataset}
ggplot(as.data.frame(Titanic),
       aes(weight = Freq,
           axis1 = Survived, axis2 = Sex, axis3 = Class)) +
  geom_alluvium(aes(fill = Class),
                width = 1/8, knot.pos = 0) +
  geom_stratum(width = 1/8) + geom_text(stat = "stratum", label.strata = TRUE) +
  scale_x_continuous(breaks = 1:3, labels = c("Survived", "Sex", "Class")) +
  coord_flip() +
  ggtitle("Titanic survival by class and sex")
```

This format and functionality are useful and will be retained in future versions. They also involve some conspicuous deviations from **ggplot2** norms:

- The `axis[0-9]*` position aesthetics are non-standard.
- `stat_alluvium()` ignores any argument to the `group` aesthetic; instead, `StatAlluvium$compute_panel()` uses `group` to link the rows of the internally-transformed dataset that correspond to the same alluvium.
- The `label.strata` parameter instructs `stat_stratum()` (called by `geom_text()`) to take the values of the axis variables as labels.
- The horizontal axis must be manually corrected (using `scale_x_continuous()`) to reflect the implicit categorical variable identifying the axis.

Furthermore, format aesthetics like `fill` are necessarily fixed for each alluvium; they cannot, for example, change from axis to axis according to the value taken at each. This means that, although they can reproduce the branching-tree structure of parallel sets, this format and functionality cannot produce alluvial diagrams with the color schemes featured [here](https://epijim.uk/code-snippets/eq5d/) ("Alluvial diagram") and [here](https://developers.google.com/chart/interactive/docs/gallery/sankey) ("Controlling colors"), which are "reset" at each axis.

### One row per lode

The second format recognized by **ggalluvial** contains one row per lode, and can be understood as the result of "gathering" (in the **dplyr** sense) the axis columns of a dataset of the preceding kind into a "key" column indicating the axis and a "value" column indicating the value taken thereat. This format requires an additional indexing column that links the rows corresponding to a common alluvium, as illustrated below using the `to_lodes()` defaults on the Berkeley admissions dataset:

```{r lode form of Berkeley admissions dataset}
UCB_lodes <- to_lodes(as.data.frame(UCBAdmissions), axes = 1:3)
head(UCB_lodes, n = 12)
is_alluvial(UCB_lodes, logical = FALSE)
```

The same stat and geom can receive this data format using a different set of positional aesthetics, also specific to **ggalluvial**:

- `x`, the "key" variable indicating the axis to which the row corresponds, which are to be arranged along the horizontal axis;
- `stratum`, the "value" taken by the axis variable indicated by `x`; and
- `alluvium`, the indexing scheme that links the rows of a single alluvium.

Weights (and weight totals) can vary from axis to axis, allowing users to produce bump charts like those showcased [here](http://imgur.com/gallery/gI5p7).[^geom-area] In these cases, the strata and the alluvia are the same, so either `stratum` or `alluvium` can be specified while omitting the other. As an example, we can grop countries in the `Refugees` dataset by region, in order to compare refugee volumes hierarchically:

[^geom-area]: If bumping is unnecessary, consider using [`geom_area()`](https://chrisalbon.com/r-stats/stacked-area-graph.html) instead.

```{r time series alluvia diagram of refugees dataset}
data(Refugees, package = "alluvial")
country_regions <- c(
  Afghanistan = "Middle East",
  Burundi = "Central Africa",
  `Congo DRC` = "Central Africa",
  Iraq = "Middle East",
  Myanmar = "Southeast Asia",
  Palestine = "Middle East",
  Somalia = "Horn of Africa",
  Sudan = "Central Africa",
  Syria = "Middle East",
  Vietnam = "Southeast Asia"
)
Refugees$region <- country_regions[Refugees$country]
ggplot(data = Refugees,
       aes(x = year, weight = refugees, stratum = country)) +
  geom_alluvium(aes(fill = country, colour = country),
                alpha = .75, decreasing = FALSE) +
  scale_fill_brewer(type = "qual", palette = "Set3") +
  scale_color_brewer(type = "qual", palette = "Set3") +
  facet_wrap(~ region, scales = "fixed") +
  ggtitle("refugee volume by country of origin and geographic region")
```

The format allows us to assign aesthetics based on the values taken at *each* axis, which is useful for repeated measures datasets, rather than only at some specific axis, as in the parallel sets example.
We can illustrate this usage on data from the influenza vaccination surveys conducted by the [RAND American Life Panel](https://alpdata.rand.org/).
`geom_alluvium()` insists on applying aesthetics uniformly to each alluvium, so to achieve this effect we use `geom_flow()`, which plots alluvial segments between adjacent axes:

```{r alluvial diagram of vaccinations dataset}
data(vaccinations)
ggplot(vaccinations,
       aes(x = survey, stratum = response, alluvium = subject,
           weight = freq,
           fill = response, label = response)) +
  geom_flow() +
  geom_stratum(alpha = .5) +
  geom_text(stat = "stratum", size = 3) +
  theme(legend.position = "none") +
  ggtitle("vaccination survey responses at three points in time")
```

Note that `geom_flow()` by default calls `stat_flow()`, which ignores any continuity between the alluvial segments linking different pairs of adjacent axes.[^alluvium-flow] This "memoryless" plot produces a less cluttered diagram, in which at most one flow proceeds from each stratum at one axis to each stratum at the next, but at the cost of being able to track each cohort across the entire diagram.

[^alluvium-flow]: This can be overridden, for example as `geom_flow(stat = "alluvium")`.

## Appendix

[Michał Bojanowski](https://github.com/mbojan) makes a habit of including R session info in each vignette. This makes eminent sense to me, so i'm doing it here.

```{r session info}
sessionInfo()
```
